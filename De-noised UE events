-- Master lookups (names vary by site; use your local dim names)
flowsheet_row_dim AS (
  SELECT DISTINCT
    frd.FlowsheetRowEpicId,
    UPPER(frd.RowName)       AS row_name,
    UPPER(frd.RowGroupName)  AS row_group
  FROM FlowsheetRowDim frd
),
lda_dim AS (
  SELECT
    l.LdaKey,
    UPPER(COALESCE(l.Type, l.Description))              AS lda_type,
    UPPER(COALESCE(l.Site, l.PropertiesDescription))    AS lda_site
  FROM LdaFact l
),

-- Whitelist flowsheet rows related to extubation/airway
extubation_rows AS (
  SELECT DISTINCT frd.FlowsheetRowEpicId
  FROM flowsheet_row_dim frd
  WHERE
    (row_name ILIKE '%extubat%' OR row_group ILIKE '%airway%' OR row_group ILIKE '%ett%')
),

-- UE events: require (1) AIRWAY/ETT LDA and (2) extubation rows and (3) 'unplanned' text
ue_events AS (
  SELECT DISTINCT
      v.LdaKey,
      fvf.TakenInstant AS EventInstant
  FROM vent_episodes v
  JOIN lda_dim ld                 ON ld.LdaKey = v.LdaKey
  JOIN FlowsheetValueFact fvf     ON fvf.LdaKey = v.LdaKey
  JOIN extubation_rows er         ON er.FlowsheetRowEpicId = fvf.FlowsheetRowEpicId
  WHERE
      -- LDA must be an AIRWAY / ETT
      (ld.lda_type ILIKE '%AIRWAY%' OR ld.lda_site ILIKE '%ENDOTRACHEAL%')
      -- UE wording (catch common variants)
      AND (
        fvf.Value ILIKE '%unplan%'
        OR (fvf.Value ILIKE '%self%' AND fvf.Value ILIKE '%extubat%')
        OR fvf.Value ILIKE '%accident%extubat%'
      )
      -- inside analysis window
      AND fvf.TakenInstant BETWEEN (SELECT start_ts FROM params) AND (SELECT end_ts FROM params)
      -- optional: ensure it aligns with the removal for THIS ETT (tighten if noise persists)
      AND ABS(DATEDIFF('minute', fvf.TakenInstant, v.RemovalInstant)) <= 120
)
